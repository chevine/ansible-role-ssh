---
# role: ansible-role-ssh
# file: tasks/sshd.yml

- name: Check if {{ sshd_moduli_file }} contains weak DH parameters
  shell: awk '$5 < {{ sshd_moduli_minimum }}' {{ sshd_moduli_file }}
  register: sshd_register_moduli
  changed_when: false
  check_mode: no

- name: Remove primes smaller than {{ sshd_moduli_minimum }}
  shell: |
    awk '$5 >= {{ sshd_moduli_minimum }}' {{ sshd_moduli_file }} > \
    {{ sshd_moduli_file }}.new
    [ -f {{ sshd_moduli_file }}.new ] && \
    mv {{ sshd_moduli_file }}.new {{ sshd_moduli_file }} || true
  when: sshd_register_moduli.stdout

- name: Start sshd
  service:
    name: "{{ sshd_service_name }}"
    state: started

- name: Inlcude local pubkey from current user in remote users authorized_keys
  become: false
  authorized_key:
    user: "{{ ansible_user | default(ansible_user_id, True) }}"
    state: present
    key: "{{ lookup('file', '~/.ssh/id_' + ssh_deploy_local_key_type + '.pub') }}"
  when: ssh_deploy_local_key_type | length > 0
    and sshd_pubkey_auth | bool

- name: Set up sshd configuration in /etc/ssh/sshd_config
  template:
    src: 'etc/ssh/sshd_config.j2'
    dest: '/etc/ssh/sshd_config'
    mode: '0600'
    owner: 'root'
    group: 'root'
    backup: "{{ sshd_conf_backup }}"
    validate: '/usr/sbin/sshd -T -C user=root -C host=localhost -C addr=localhost -f %s'
  notify: restart sshd
